<!DOCTYPE html>
<html lang=<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>AI 名片管家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans TC", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
      }
      #cameraInterface {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 9000;
        display: flex;
        flex-direction: column;
        visibility: hidden;
      }
      #cameraInterface.active {
        visibility: visible;
      }
      #cameraFeed {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }
      .guide-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .guide-box {
        position: relative;
        width: 85%;
        aspect-ratio: 1.6/1;
        border-radius: 12px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
        border: 2px solid rgba(255, 255, 255, 0.5);
      }
      .scan-laser {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: #06c755;
        box-shadow: 0 0 15px #06c755;
        animation: scanning 2s linear infinite;
      }
      @keyframes scanning {
        0% {
          top: 0%;
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          top: 100%;
          opacity: 0;
        }
      }
    </style>
  </head>
  <body
    class="gradient-bg min-h-screen text-slate-800 flex flex-col items-center p-4"
  >
    <header
      class="w-full max-w-md flex justify-between items-center mb-6 mt-2 text-white z-10"
    >
      <div class="flex items-center gap-2">
        <div class="bg-[#06C755] p-1.5 rounded-lg shadow-lg">
          <i data-lucide="scan-face" class="w-6 h-6 text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold">AI 名片管家</h1>
          <p id="browserInfo" class="text-[10px] text-green-100">v25.2</p>
        </div>
      </div>
    </header>

    <main class="w-full max-w-md relative z-0 flex-1 flex flex-col w-full">
      <!-- Toast -->
      <div
        id="statusToast"
        class="hidden fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-4 rounded-xl shadow-2xl text-sm font-bold transition-all duration-300 flex items-center gap-3 min-w-[320px] border backdrop-blur-md"
      >
        <span id="statusIcon"></span><span id="statusText"></span>
      </div>

      <!-- Start Screen -->
      <div
        id="startScreen"
        class="glass-panel rounded-3xl p-6 shadow-2xl flex flex-col items-center justify-center min-h-[400px] gap-6 animate-fade-in"
      >
        <div
          class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 shadow-inner border-4 border-white"
        >
          <i data-lucide="camera" class="w-10 h-10"></i>
        </div>
        <div class="text-center px-4 mt-2">
          <h2 class="text-xl font-bold text-slate-800">開始掃描</h2>
          <p class="text-sm text-slate-500 mt-1">請確保光線充足</p>
        </div>
        <div class="w-full space-y-3 mt-4">
          <button
            onclick="attemptStartCamera()"
            class="w-full bg-[#06C755] hover:bg-[#05b34c] text-white py-4 rounded-xl font-bold shadow-lg shadow-green-500/30 flex items-center justify-center gap-2 active:scale-95 transition-transform"
          >
            <i data-lucide="aperture" class="w-5 h-5"></i>開啟相機
          </button>
          <button
            onclick="triggerFileInput()"
            class="w-full bg-white hover:bg-slate-50 text-slate-600 py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform border border-slate-200"
          >
            <i data-lucide="image" class="w-5 h-5"></i>上傳圖片
          </button>
        </div>
        <input
          type="file"
          id="fileInput"
          accept="image/*"
          class="hidden"
          onchange="handleFileSelect(event)"
        />
      </div>

      <!-- Camera Interface -->
      <div id="cameraInterface">
        <div
          class="absolute top-0 left-0 right-0 z-[100] p-4 flex justify-between items-center text-white bg-gradient-to-b from-black/60 to-transparent"
        >
          <button
            onclick="closeCamera()"
            class="p-2 bg-white/10 rounded-full backdrop-blur-md"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
          <span class="text-sm font-medium tracking-wider shadow-sm"
            >將名片放入框內</span
          >
          <button
            onclick="switchCamera()"
            class="p-2 bg-white/10 rounded-full backdrop-blur-md"
          >
            <i data-lucide="refresh-ccw" class="w-6 h-6"></i>
          </button>
        </div>
        <video id="cameraFeed" autoplay playsinline muted></video>
        <canvas id="cameraCanvas" class="hidden"></canvas>
        <div class="guide-overlay">
          <div class="guide-box"><div class="scan-laser"></div></div>
        </div>
        <div
          class="absolute bottom-0 left-0 right-0 h-32 bg-black/50 backdrop-blur-sm flex flex-col justify-center items-center pb-6 z-[100]"
        >
          <button
            onclick="takePhoto()"
            class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center active:scale-95 transition-transform bg-white/20"
          >
            <div class="w-16 h-16 bg-white rounded-full"></div>
          </button>
        </div>
      </div>

      <!-- Processing -->
      <div
        id="processingState"
        class="hidden flex-col items-center justify-center fixed inset-0 z-[100] bg-black/90 backdrop-blur-md"
      >
        <div class="relative w-20 h-20 mb-4">
          <div
            class="absolute inset-0 border-4 border-slate-500/30 rounded-full"
          ></div>
          <div
            class="absolute inset-0 border-4 border-[#06C755] rounded-full border-t-transparent animate-spin"
          ></div>
        </div>
        <p class="text-white font-bold text-lg">AI 分析中...</p>
      </div>

      <!-- Result Card -->
      <div
        id="resultCard"
        class="glass-panel rounded-2xl p-0 shadow-xl hidden transition-all duration-500 overflow-hidden flex flex-col max-h-[85vh] w-full"
      >
        <div class="bg-slate-50 border-b p-3 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div
              class="w-16 h-10 bg-slate-200 overflow-hidden border border-slate-300 relative rounded shadow-sm"
            >
              <img
                id="contactPhotoPreview"
                class="w-full h-full object-cover"
              />
            </div>
            <div>
              <h3 class="text-sm font-bold text-slate-700">辨識結果</h3>
            </div>
          </div>
          <button
            onclick="resetApp()"
            class="text-xs text-red-500 hover:text-red-600 px-2 py-1"
          >
            重掃
          </button>
        </div>
        <form
          id="contactForm"
          class="p-4 space-y-3 bg-white flex-1 overflow-y-auto"
        >
          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
                >姓名</label
              ><input
                type="text"
                id="fieldName"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 font-bold"
              />
            </div>
            <div class="space-y-1">
              <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
                >職稱</label
              ><input
                type="text"
                id="fieldTitle"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-600 text-sm"
              />
            </div>
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >公司</label
            ><input
              type="text"
              id="fieldCompany"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >手機</label
            ><input
              type="tel"
              id="fieldMobile"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >Email</label
            ><input
              type="email"
              id="fieldEmail"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >地址</label
            ><input
              type="text"
              id="fieldAddress"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
        </form>
        <div class="p-4 bg-slate-50 border-t space-y-2">
          <button
            onclick="exportContact()"
            class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"
          >
            <i data-lucide="download" class="w-5 h-5"></i>
            匯入手機通訊錄
          </button>
        </div>
      </div>

      <!-- LINE Error Modal -->
      <div
        id="lineErrorModal"
        class="hidden fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 animate-fade-in"
      >
        <div
          class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl relative"
        >
          <button
            onclick="document.getElementById('lineErrorModal').classList.add('hidden')"
            class="absolute top-4 right-4 text-slate-400"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
          <div class="flex items-center gap-2 mb-4 text-amber-500">
            <i data-lucide="external-link" class="w-6 h-6"></i>
            <h3 class="text-lg font-bold text-slate-800">請開啟外部瀏覽器</h3>
          </div>
          <p class="text-sm text-slate-600 mb-4 font-medium">
            iOS 的 LINE 無法直接儲存聯絡人，請依照指示操作：
          </p>
          <div
            class="bg-slate-100 p-4 rounded-xl space-y-3 text-sm text-slate-700"
          >
            <div class="flex gap-3 items-start">
              <div
                class="w-6 h-6 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs"
              >
                1
              </div>
              <p>
                點擊右上角的 <span class="font-bold">「︙」</span> 或分享圖示
              </p>
            </div>
            <div class="flex gap-3 items-start">
              <div
                class="w-6 h-6 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs"
              >
                2
              </div>
              <p>
                選擇
                <span class="font-bold text-blue-600"
                  >「使用預設瀏覽器開啟」</span
                >
                (Safari)
              </p>
            </div>
            <div class="flex gap-3 items-start">
              <div
                class="w-6 h-6 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs"
              >
                3
              </div>
              <p>
                在 Safari 中點擊
                <span class="font-bold">「匯入」</span>，即可自動開啟聯絡人App。
              </p>
            </div>
          </div>
          <button
            onclick="document.getElementById('lineErrorModal').classList.add('hidden')"
            class="w-full mt-6 bg-[#06C755] text-white py-3 rounded-xl font-bold"
          >
            我了解了
          </button>
        </div>
      </div>
    </main>

    <script>
      // ==========================================
      // ★★★ 設定區 ★★★
      // ==========================================

      // 請填入你剛剛部署好的 Google Apps Script 新網址
      const BACKEND_API_URL =
        "https://script.google.com/macros/s/AKfycbx-Dr4vdYi51FbM_I6RP8L63OZh3Nljd9FwqC5jAuqfzthvw-zxVgvZSOlqSbYv1Wa6Ew/exec";

      // 這些全域變數保持不變
      let stream = null;
      let facingMode = "environment";
      let currentHighResBase64 = null;

      document.addEventListener("DOMContentLoaded", () => {
        lucide.createIcons();
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const isLine = ua.indexOf("Line") > -1;
        document.getElementById("browserInfo").textContent = isLine
          ? "Line Mode"
          : "Web Mode";
      });

      // --- Camera Logic (修正版：加入壓縮) ---
      async function attemptStartCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia)
          return showToast("error", "瀏覽器不支援相機");
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facingMode, width: { ideal: 1920 } },
          });
          onCameraSuccess(stream);
        } catch (err) {
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: facingMode },
            });
            onCameraSuccess(stream);
          } catch (fatalErr) {
            showToast("error", "相機啟動失敗，請改用上傳");
            setTimeout(() => triggerFileInput(), 1500);
          }
        }
      }

      function onCameraSuccess(stream) {
        const video = document.getElementById("cameraFeed");
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          document.getElementById("startScreen").classList.add("hidden");
          document.getElementById("cameraInterface").classList.add("active");
        };
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
        document.getElementById("cameraInterface").classList.remove("active");
      }

      function closeCamera() {
        stopCamera();
        document.getElementById("startScreen").classList.remove("hidden");
      }

      async function switchCamera() {
        stopCamera();
        facingMode = facingMode === "environment" ? "user" : "environment";
        await attemptStartCamera();
      }

      // ★ 修改重點：拍照時強制縮小圖片 ★
      function takePhoto() {
        const video = document.getElementById("cameraFeed");
        const canvas = document.getElementById("cameraCanvas");

        // 設定最大邊長為 800px (保證後端收得到)
        const maxDim = 800;
        let w = video.videoWidth;
        let h = video.videoHeight;

        // 計算等比例縮放
        if (w > maxDim || h > maxDim) {
          const scale = maxDim / Math.max(w, h);
          w = w * scale;
          h = h * scale;
        }

        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, w, h);

        // 轉出較小的 Base64
        const finalBase64 = canvas.toDataURL("image/jpeg", 0.7);
        currentHighResBase64 = finalBase64.split(",")[1];
        document.getElementById("contactPhotoPreview").src = finalBase64;

        closeCamera();
        analyzeImage(currentHighResBase64);
      }

      // --- Upload Logic (修正版：加強壓縮) ---
      function triggerFileInput() {
        document.getElementById("fileInput").click();
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            const c = document.createElement("canvas");
            // ★ 修改重點：將原本的 1500 改為 800，確保秒傳 ★
            const maxDim = 800;
            const scale =
              img.width > maxDim || img.height > maxDim
                ? maxDim / Math.max(img.width, img.height)
                : 1;
            c.width = img.width * scale;
            c.height = img.height * scale;
            c.getContext("2d").drawImage(img, 0, 0, c.width, c.height);

            const b64 = c.toDataURL("image/jpeg", 0.7);
            currentHighResBase64 = b64.split(",")[1];
            document.getElementById("contactPhotoPreview").src = b64;
            analyzeImage(currentHighResBase64);
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }

      // --- Analyze Logic (後端溝通) ---
      async function analyzeImage(base64Data) {
        if (!base64Data) return showToast("error", "影像處理失敗");

        const loading = document.getElementById("processingState");
        loading.classList.remove("hidden");
        loading.classList.add("flex");

        try {
          // 發送 POST 請求
          const res = await fetch(BACKEND_API_URL, {
            method: "POST",
            // 避免 CORS 預檢請求問題，使用 text/plain
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ image: base64Data }),
          });

          const json = await res.json();

          if (json.status !== "success") {
            throw new Error(json.message || "辨識失敗");
          }

          const card = json.data;

          // 填入介面
          document.getElementById("fieldName").value = card.name || "";
          document.getElementById("fieldTitle").value = card.title || "";
          document.getElementById("fieldCompany").value = card.company || "";
          document.getElementById("fieldMobile").value = card.mobile || "";
          document.getElementById("fieldEmail").value = card.email || "";
          document.getElementById("fieldAddress").value = card.address || "";

          loading.classList.add("hidden");
          loading.classList.remove("flex");
          document.getElementById("resultCard").classList.remove("hidden");
          document.getElementById("startScreen").classList.add("hidden");
          showToast("success", "辨識成功");
        } catch (error) {
          console.error(error);
          loading.classList.add("hidden");
          loading.classList.remove("flex");

          // 如果是 HTML 錯誤，提示部署設定
          if (error.message && error.message.includes("<")) {
            alert("系統錯誤：後端權限設定異常，請確認 GAS 部署為 '任何人'");
          } else {
            alert("錯誤：" + error.message);
          }
          document.getElementById("startScreen").classList.remove("hidden");
        }
      }

      // --- Export Logic (保留你原本完美的邏輯) ---
      // ==========================================
      // ★★★ 請用這整段取代原本的 generateVCardFile 函式 ★★★
      // ==========================================
      function generateVCardFile(name) {
        // 1. 建立 VCard 內容字串
        let vcard = `BEGIN:VCARD\nVERSION:3.0\nN;CHARSET=UTF-8:${name};;;;\nFN;CHARSET=UTF-8:${name}\nTEL;TYPE=CELL:${
          document.getElementById("fieldMobile").value
        }\nEMAIL:${
          document.getElementById("fieldEmail").value
        }\nORG;CHARSET=UTF-8:${
          document.getElementById("fieldCompany").value
        }\nTITLE;CHARSET=UTF-8:${
          document.getElementById("fieldTitle").value
        }\nADR;TYPE=WORK;CHARSET=UTF-8:;;${
          document.getElementById("fieldAddress").value
        };;;;\n`;

        // 2. 如果有照片，加進去
        if (currentHighResBase64) {
          vcard += `PHOTO;ENCODING=b;TYPE=JPEG:${currentHighResBase64}\n`;
        }
        vcard += `END:VCARD`;

        // 3. 封裝成檔案物件
        // ★ 關鍵優化：使用 'text/vcard' 並強制 charset=utf-8，這對 Android 相容性最好
        return new File(
          [new Blob([vcard], { type: "text/vcard;charset=utf-8" })],
          `${name}.vcf`,
          { type: "text/vcard" }
        );
      }

      // ==========================================
      // ★★★ 請用這整段取代原本的 exportContact 函式 ★★★
      // ==========================================
      async function exportContact() {
        const name = document.getElementById("fieldName").value || "Contact";
        const file = generateVCardFile(name);
        const url = URL.createObjectURL(file);
        const ua = navigator.userAgent || navigator.vendor || window.opera;

        // --- 1. iOS 專用通道 (保持完美體驗) ---
        const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
        if (isIOS) {
          const isLine = ua.indexOf("Line") > -1;
          if (isLine) {
            // 如果是 LINE 瀏覽器，顯示教學引導
            document
              .getElementById("lineErrorModal")
              .classList.remove("hidden");
            return;
          }
          // iOS Safari 看到這個會自動叫出名片預覽
          window.location.href = url;
          setTimeout(() => URL.revokeObjectURL(url), 3000); // 釋放記憶體
          return;
        }

        // --- 2. Android / 電腦版 混合策略 ---

        // 策略 A: 優先嘗試 Web Share API (現代 Android 標準)
        // 這會叫出系統選單，使用者選「聯絡人」就能直接存
        if (
          navigator.share &&
          navigator.canShare &&
          navigator.canShare({ files: [file] })
        ) {
          try {
            await navigator.share({
              files: [file],
              title: "儲存聯絡人",
              text: `匯入名片：${name}`,
            });
            showToast("success", "請選擇「聯絡人」App 來開啟");
          } catch (err) {
            // 如果使用者按了取消，或是分享失敗，我們才進入策略 B
            if (err.name !== "AbortError") {
              console.log("Share failed, falling back to download");
              // 降級處理：呼叫下載
              startDownload(file);
            }
          }
          return; // 如果成功呼叫分享，就結束
        }

        // 策略 B: 嘗試直接導航 (針對部分舊 Android 或特定瀏覽器)
        // 有些 Android 瀏覽器跟 iOS 一樣，讀到 vcf 會問你要不要匯入
        window.location.href = url;

        // 策略 C: 強制下載 (保底方案)
        // 如果上面策略 B 執行後 1 秒鐘網頁還活著(沒跳轉)，代表瀏覽器看不懂
        // 那就強制把檔案下載下來
        setTimeout(() => {
          startDownload(file);
        }, 1000);
      }
      function startDownload() {
        const name = document.getElementById("fieldName").value || "Contact";
        const file = generateVCardFile(name);
        const url = URL.createObjectURL(file);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = `${name}.vcf`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        showToast("success", "已下載 vCard");
      }

      function resetApp() {
        document.getElementById("resultCard").classList.add("hidden");
        document.getElementById("startScreen").classList.remove("hidden");
        document.getElementById("contactForm").reset();
      }

      function showToast(type, msg) {
        const t = document.getElementById("statusToast");
        const i = document.getElementById("statusIcon");
        const txt = document.getElementById("statusText");
        t.className = `fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-4 rounded-xl shadow-2xl text-sm font-bold transition-all duration-300 flex items-center gap-3 min-w-[320px] border backdrop-blur-md ${
          type === "error"
            ? "bg-red-500/90 text-white border-red-400"
            : type === "success"
            ? "bg-green-500/90 text-white border-green-400"
            : "bg-blue-500/90 text-white border-blue-400"
        }`;

        // 簡單的 icon 對應
        let iconName = "info";
        if (type === "success") iconName = "check-circle";
        if (type === "error") iconName = "alert-circle";

        i.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5"></i>`;
        txt.innerText = msg;
        t.classList.remove("hidden");
        lucide.createIcons();
        setTimeout(() => t.classList.add("hidden"), 4000);
      }
    </script>
  </body>
</html>
"zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>AI 名片管家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Noto Sans TC", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
      }
      #cameraInterface {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 9000;
        display: flex;
        flex-direction: column;
        visibility: hidden;
      }
      #cameraInterface.active {
        visibility: visible;
      }
      #cameraFeed {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
      }
      .guide-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 10;
        pointer-events: none;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .guide-box {
        position: relative;
        width: 85%;
        aspect-ratio: 1.6/1;
        border-radius: 12px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
        border: 2px solid rgba(255, 255, 255, 0.5);
      }
      .scan-laser {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: #06c755;
        box-shadow: 0 0 15px #06c755;
        animation: scanning 2s linear infinite;
      }
      @keyframes scanning {
        0% {
          top: 0%;
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          top: 100%;
          opacity: 0;
        }
      }
    </style>
  </head>
  <body
    class="gradient-bg min-h-screen text-slate-800 flex flex-col items-center p-4"
  >
    <header
      class="w-full max-w-md flex justify-between items-center mb-6 mt-2 text-white z-10"
    >
      <div class="flex items-center gap-2">
        <div class="bg-[#06C755] p-1.5 rounded-lg shadow-lg">
          <i data-lucide="scan-face" class="w-6 h-6 text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold">AI 名片管家</h1>
          <p id="browserInfo" class="text-[10px] text-green-100">v25.2</p>
        </div>
      </div>
    </header>

    <main class="w-full max-w-md relative z-0 flex-1 flex flex-col w-full">
      <!-- Toast -->
      <div
        id="statusToast"
        class="hidden fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-4 rounded-xl shadow-2xl text-sm font-bold transition-all duration-300 flex items-center gap-3 min-w-[320px] border backdrop-blur-md"
      >
        <span id="statusIcon"></span><span id="statusText"></span>
      </div>

      <!-- Start Screen -->
      <div
        id="startScreen"
        class="glass-panel rounded-3xl p-6 shadow-2xl flex flex-col items-center justify-center min-h-[400px] gap-6 animate-fade-in"
      >
        <div
          class="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 shadow-inner border-4 border-white"
        >
          <i data-lucide="camera" class="w-10 h-10"></i>
        </div>
        <div class="text-center px-4 mt-2">
          <h2 class="text-xl font-bold text-slate-800">開始掃描</h2>
          <p class="text-sm text-slate-500 mt-1">請確保光線充足</p>
        </div>
        <div class="w-full space-y-3 mt-4">
          <button
            onclick="attemptStartCamera()"
            class="w-full bg-[#06C755] hover:bg-[#05b34c] text-white py-4 rounded-xl font-bold shadow-lg shadow-green-500/30 flex items-center justify-center gap-2 active:scale-95 transition-transform"
          >
            <i data-lucide="aperture" class="w-5 h-5"></i>開啟相機
          </button>
          <button
            onclick="triggerFileInput()"
            class="w-full bg-white hover:bg-slate-50 text-slate-600 py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform border border-slate-200"
          >
            <i data-lucide="image" class="w-5 h-5"></i>上傳圖片
          </button>
        </div>
        <input
          type="file"
          id="fileInput"
          accept="image/*"
          class="hidden"
          onchange="handleFileSelect(event)"
        />
      </div>

      <!-- Camera Interface -->
      <div id="cameraInterface">
        <div
          class="absolute top-0 left-0 right-0 z-[100] p-4 flex justify-between items-center text-white bg-gradient-to-b from-black/60 to-transparent"
        >
          <button
            onclick="closeCamera()"
            class="p-2 bg-white/10 rounded-full backdrop-blur-md"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
          <span class="text-sm font-medium tracking-wider shadow-sm"
            >將名片放入框內</span
          >
          <button
            onclick="switchCamera()"
            class="p-2 bg-white/10 rounded-full backdrop-blur-md"
          >
            <i data-lucide="refresh-ccw" class="w-6 h-6"></i>
          </button>
        </div>
        <video id="cameraFeed" autoplay playsinline muted></video>
        <canvas id="cameraCanvas" class="hidden"></canvas>
        <div class="guide-overlay">
          <div class="guide-box"><div class="scan-laser"></div></div>
        </div>
        <div
          class="absolute bottom-0 left-0 right-0 h-32 bg-black/50 backdrop-blur-sm flex flex-col justify-center items-center pb-6 z-[100]"
        >
          <button
            onclick="takePhoto()"
            class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center active:scale-95 transition-transform bg-white/20"
          >
            <div class="w-16 h-16 bg-white rounded-full"></div>
          </button>
        </div>
      </div>

      <!-- Processing -->
      <div
        id="processingState"
        class="hidden flex-col items-center justify-center fixed inset-0 z-[100] bg-black/90 backdrop-blur-md"
      >
        <div class="relative w-20 h-20 mb-4">
          <div
            class="absolute inset-0 border-4 border-slate-500/30 rounded-full"
          ></div>
          <div
            class="absolute inset-0 border-4 border-[#06C755] rounded-full border-t-transparent animate-spin"
          ></div>
        </div>
        <p class="text-white font-bold text-lg">AI 分析中...</p>
      </div>

      <!-- Result Card -->
      <div
        id="resultCard"
        class="glass-panel rounded-2xl p-0 shadow-xl hidden transition-all duration-500 overflow-hidden flex flex-col max-h-[85vh] w-full"
      >
        <div class="bg-slate-50 border-b p-3 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div
              class="w-16 h-10 bg-slate-200 overflow-hidden border border-slate-300 relative rounded shadow-sm"
            >
              <img
                id="contactPhotoPreview"
                class="w-full h-full object-cover"
              />
            </div>
            <div>
              <h3 class="text-sm font-bold text-slate-700">辨識結果</h3>
            </div>
          </div>
          <button
            onclick="resetApp()"
            class="text-xs text-red-500 hover:text-red-600 px-2 py-1"
          >
            重掃
          </button>
        </div>
        <form
          id="contactForm"
          class="p-4 space-y-3 bg-white flex-1 overflow-y-auto"
        >
          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
                >姓名</label
              ><input
                type="text"
                id="fieldName"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 font-bold"
              />
            </div>
            <div class="space-y-1">
              <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
                >職稱</label
              ><input
                type="text"
                id="fieldTitle"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-600 text-sm"
              />
            </div>
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >公司</label
            ><input
              type="text"
              id="fieldCompany"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >手機</label
            ><input
              type="tel"
              id="fieldMobile"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >Email</label
            ><input
              type="email"
              id="fieldEmail"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >地址</label
            ><input
              type="text"
              id="fieldAddress"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
        </form>
        <div class="p-4 bg-slate-50 border-t space-y-2">
          <button
            onclick="exportContact()"
            class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform"
          >
            <i data-lucide="download" class="w-5 h-5"></i>
            匯入手機通訊錄
          </button>
        </div>
      </div>

      <!-- LINE Error Modal -->
      <div
        id="lineErrorModal"
        class="hidden fixed inset-0 z-[110] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 animate-fade-in"
      >
        <div
          class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl relative"
        >
          <button
            onclick="document.getElementById('lineErrorModal').classList.add('hidden')"
            class="absolute top-4 right-4 text-slate-400"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
          <div class="flex items-center gap-2 mb-4 text-amber-500">
            <i data-lucide="external-link" class="w-6 h-6"></i>
            <h3 class="text-lg font-bold text-slate-800">請開啟外部瀏覽器</h3>
          </div>
          <p class="text-sm text-slate-600 mb-4 font-medium">
            iOS 的 LINE 無法直接儲存聯絡人，請依照指示操作：
          </p>
          <div
            class="bg-slate-100 p-4 rounded-xl space-y-3 text-sm text-slate-700"
          >
            <div class="flex gap-3 items-start">
              <div
                class="w-6 h-6 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs"
              >
                1
              </div>
              <p>
                點擊右上角的 <span class="font-bold">「︙」</span> 或分享圖示
              </p>
            </div>
            <div class="flex gap-3 items-start">
              <div
                class="w-6 h-6 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs"
              >
                2
              </div>
              <p>
                選擇
                <span class="font-bold text-blue-600"
                  >「使用預設瀏覽器開啟」</span
                >
                (Safari)
              </p>
            </div>
            <div class="flex gap-3 items-start">
              <div
                class="w-6 h-6 bg-slate-800 text-white rounded-full flex items-center justify-center font-bold flex-shrink-0 text-xs"
              >
                3
              </div>
              <p>
                在 Safari 中點擊
                <span class="font-bold">「匯入」</span>，即可自動開啟聯絡人App。
              </p>
            </div>
          </div>
          <button
            onclick="document.getElementById('lineErrorModal').classList.add('hidden')"
            class="w-full mt-6 bg-[#06C755] text-white py-3 rounded-xl font-bold"
          >
            我了解了
          </button>
        </div>
      </div>
    </main>

    <script>
      // ==========================================
      // ★★★ 設定區 ★★★
      // ==========================================

      // 請填入你剛剛部署好的 Google Apps Script 新網址
      const BACKEND_API_URL =
        "https://script.google.com/macros/s/AKfycbx-Dr4vdYi51FbM_I6RP8L63OZh3Nljd9FwqC5jAuqfzthvw-zxVgvZSOlqSbYv1Wa6Ew/exec";

      // 這些全域變數保持不變
      let stream = null;
      let facingMode = "environment";
      let currentHighResBase64 = null;

      document.addEventListener("DOMContentLoaded", () => {
        lucide.createIcons();
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const isLine = ua.indexOf("Line") > -1;
        document.getElementById("browserInfo").textContent = isLine
          ? "Line Mode"
          : "Web Mode";
      });

      // --- Camera Logic (修正版：加入壓縮) ---
      async function attemptStartCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia)
          return showToast("error", "瀏覽器不支援相機");
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: facingMode, width: { ideal: 1920 } },
          });
          onCameraSuccess(stream);
        } catch (err) {
          try {
            stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: facingMode },
            });
            onCameraSuccess(stream);
          } catch (fatalErr) {
            showToast("error", "相機啟動失敗，請改用上傳");
            setTimeout(() => triggerFileInput(), 1500);
          }
        }
      }

      function onCameraSuccess(stream) {
        const video = document.getElementById("cameraFeed");
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          document.getElementById("startScreen").classList.add("hidden");
          document.getElementById("cameraInterface").classList.add("active");
        };
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
        document.getElementById("cameraInterface").classList.remove("active");
      }

      function closeCamera() {
        stopCamera();
        document.getElementById("startScreen").classList.remove("hidden");
      }

      async function switchCamera() {
        stopCamera();
        facingMode = facingMode === "environment" ? "user" : "environment";
        await attemptStartCamera();
      }

      // ★ 修改重點：拍照時強制縮小圖片 ★
      function takePhoto() {
        const video = document.getElementById("cameraFeed");
        const canvas = document.getElementById("cameraCanvas");

        // 設定最大邊長為 800px (保證後端收得到)
        const maxDim = 800;
        let w = video.videoWidth;
        let h = video.videoHeight;

        // 計算等比例縮放
        if (w > maxDim || h > maxDim) {
          const scale = maxDim / Math.max(w, h);
          w = w * scale;
          h = h * scale;
        }

        canvas.width = w;
        canvas.height = h;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, w, h);

        // 轉出較小的 Base64
        const finalBase64 = canvas.toDataURL("image/jpeg", 0.7);
        currentHighResBase64 = finalBase64.split(",")[1];
        document.getElementById("contactPhotoPreview").src = finalBase64;

        closeCamera();
        analyzeImage(currentHighResBase64);
      }

      // --- Upload Logic (修正版：加強壓縮) ---
      function triggerFileInput() {
        document.getElementById("fileInput").click();
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            const c = document.createElement("canvas");
            // ★ 修改重點：將原本的 1500 改為 800，確保秒傳 ★
            const maxDim = 800;
            const scale =
              img.width > maxDim || img.height > maxDim
                ? maxDim / Math.max(img.width, img.height)
                : 1;
            c.width = img.width * scale;
            c.height = img.height * scale;
            c.getContext("2d").drawImage(img, 0, 0, c.width, c.height);

            const b64 = c.toDataURL("image/jpeg", 0.7);
            currentHighResBase64 = b64.split(",")[1];
            document.getElementById("contactPhotoPreview").src = b64;
            analyzeImage(currentHighResBase64);
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }

      // --- Analyze Logic (後端溝通) ---
      async function analyzeImage(base64Data) {
        if (!base64Data) return showToast("error", "影像處理失敗");

        const loading = document.getElementById("processingState");
        loading.classList.remove("hidden");
        loading.classList.add("flex");

        try {
          // 發送 POST 請求
          const res = await fetch(BACKEND_API_URL, {
            method: "POST",
            // 避免 CORS 預檢請求問題，使用 text/plain
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ image: base64Data }),
          });

          const json = await res.json();

          if (json.status !== "success") {
            throw new Error(json.message || "辨識失敗");
          }

          const card = json.data;

          // 填入介面
          document.getElementById("fieldName").value = card.name || "";
          document.getElementById("fieldTitle").value = card.title || "";
          document.getElementById("fieldCompany").value = card.company || "";
          document.getElementById("fieldMobile").value = card.mobile || "";
          document.getElementById("fieldEmail").value = card.email || "";
          document.getElementById("fieldAddress").value = card.address || "";

          loading.classList.add("hidden");
          loading.classList.remove("flex");
          document.getElementById("resultCard").classList.remove("hidden");
          document.getElementById("startScreen").classList.add("hidden");
          showToast("success", "辨識成功");
        } catch (error) {
          console.error(error);
          loading.classList.add("hidden");
          loading.classList.remove("flex");

          // 如果是 HTML 錯誤，提示部署設定
          if (error.message && error.message.includes("<")) {
            alert("系統錯誤：後端權限設定異常，請確認 GAS 部署為 '任何人'");
          } else {
            alert("錯誤：" + error.message);
          }
          document.getElementById("startScreen").classList.remove("hidden");
        }
      }

      // --- Export Logic (保留你原本完美的邏輯) ---
      function exportContact() {
        const ua = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;

        if (isIOS) {
          const isLine = ua.indexOf("Line") > -1;
          if (isLine) {
            document
              .getElementById("lineErrorModal")
              .classList.remove("hidden");
            return;
          }
          const name = document.getElementById("fieldName").value || "Contact";
          const file = generateVCardFile(name);
          const url = URL.createObjectURL(file);
          window.location.href = url;
          setTimeout(() => URL.revokeObjectURL(url), 3000);
          return;
        }

        const name = document.getElementById("fieldName").value || "Contact";
        const file = generateVCardFile(name);

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator
            .share({ files: [file], title: "新增聯絡人" })
            .catch(() => startDownload());
        } else {
          startDownload();
        }
      }

      function startDownload() {
        const name = document.getElementById("fieldName").value || "Contact";
        const file = generateVCardFile(name);
        const url = URL.createObjectURL(file);
        const a = document.createElement("a");
        a.style.display = "none";
        a.href = url;
        a.download = `${name}.vcf`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);
        showToast("success", "已下載 vCard");
      }

      function generateVCardFile(name) {
        let vcard = `BEGIN:VCARD\nVERSION:3.0\nN;CHARSET=UTF-8:${name};;;;\nFN;CHARSET=UTF-8:${name}\nTEL;TYPE=CELL:${
          document.getElementById("fieldMobile").value
        }\nEMAIL:${
          document.getElementById("fieldEmail").value
        }\nORG;CHARSET=UTF-8:${
          document.getElementById("fieldCompany").value
        }\nTITLE;CHARSET=UTF-8:${
          document.getElementById("fieldTitle").value
        }\nADR;TYPE=WORK;CHARSET=UTF-8:;;${
          document.getElementById("fieldAddress").value
        };;;;\n`;
        // 如果有圖片，加回去
        if (currentHighResBase64) {
          // 注意：有些手機通訊錄匯入太大的 Base64 會失敗，這裡用原本壓縮後的即可
          vcard += `PHOTO;ENCODING=b;TYPE=JPEG:${currentHighResBase64}\n`;
        }
        vcard += `END:VCARD`;
        return new File(
          [new Blob([vcard], { type: "text/vcard;charset=utf-8" })],
          `${name}.vcf`,
          { type: "text/vcard" }
        );
      }

      function resetApp() {
        document.getElementById("resultCard").classList.add("hidden");
        document.getElementById("startScreen").classList.remove("hidden");
        document.getElementById("contactForm").reset();
      }

      function showToast(type, msg) {
        const t = document.getElementById("statusToast");
        const i = document.getElementById("statusIcon");
        const txt = document.getElementById("statusText");
        t.className = `fixed top-24 left-1/2 transform -translate-x-1/2 z-[100] px-6 py-4 rounded-xl shadow-2xl text-sm font-bold transition-all duration-300 flex items-center gap-3 min-w-[320px] border backdrop-blur-md ${
          type === "error"
            ? "bg-red-500/90 text-white border-red-400"
            : type === "success"
            ? "bg-green-500/90 text-white border-green-400"
            : "bg-blue-500/90 text-white border-blue-400"
        }`;

        // 簡單的 icon 對應
        let iconName = "info";
        if (type === "success") iconName = "check-circle";
        if (type === "error") iconName = "alert-circle";

        i.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5"></i>`;
        txt.innerText = msg;
        t.classList.remove("hidden");
        lucide.createIcons();
        setTimeout(() => t.classList.add("hidden"), 4000);
      }
    </script>
  </body>
</html>

