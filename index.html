<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>AI 名片掃描 (純淨測試版)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Noto Sans TC", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%);
      }

      /* --- 核心相機介面樣式 (強制覆蓋) --- */
      #cameraInterface {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 9000; /* 確保在最上層 */
        display: flex;
        flex-direction: column;
      }

      /* 影片層 */
      #cameraFeed {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        z-index: 1;
      }

      /* 導引框層 (必須比影片高) */
      .guide-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999; /* 最高層級 */
        pointer-events: none; /* 讓點擊穿透 */
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* 框框本體 */
      .guide-box {
        position: relative;
        width: 85%;
        aspect-ratio: 1.6/1;
        border-radius: 12px;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); /*這會讓框框以外變黑 */
        border: 2px solid rgba(255, 255, 255, 0.3);
      }

      /* 四個角落 */
      .corner {
        position: absolute;
        width: 20px;
        height: 20px;
        border-color: #3b82f6;
        border-style: solid;
      }
      .tl {
        top: -2px;
        left: -2px;
        border-width: 4px 0 0 4px;
        border-radius: 4px 0 0 0;
      }
      .tr {
        top: -2px;
        right: -2px;
        border-width: 4px 4px 0 0;
        border-radius: 0 4px 0 0;
      }
      .bl {
        bottom: -2px;
        left: -2px;
        border-width: 0 0 4px 4px;
        border-radius: 0 0 0 4px;
      }
      .br {
        bottom: -2px;
        right: -2px;
        border-width: 0 4px 4px 0;
        border-radius: 0 0 4px 0;
      }

      /* 掃描雷射動畫 */
      .scan-laser {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: #60a5fa;
        box-shadow: 0 0 10px #3b82f6;
        animation: scanning 2s linear infinite;
      }
      @keyframes scanning {
        0% {
          top: 0%;
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          top: 100%;
          opacity: 0;
        }
      }
    </style>
  </head>
  <body
    class="gradient-bg min-h-screen text-slate-800 flex flex-col items-center p-4"
  >
    <!-- Header -->
    <header
      class="w-full max-w-md flex justify-between items-center mb-6 mt-2 text-white z-10"
    >
      <div class="flex items-center gap-2">
        <div class="bg-white/20 p-2 rounded-lg">
          <i data-lucide="scan-line" class="w-6 h-6 text-white"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold">AI 名片掃描</h1>
          <p class="text-[10px] text-blue-100">純淨測試版 v20.0</p>
        </div>
      </div>
      <button
        onclick="toggleSettings()"
        class="p-2 bg-white/10 hover:bg-white/20 rounded-full"
      >
        <i data-lucide="settings" class="w-5 h-5"></i>
      </button>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-md relative z-0 flex-1 flex flex-col w-full">
      <!-- Toast Notification -->
      <div
        id="statusToast"
        class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 z-[100] px-4 py-3 rounded-xl shadow-2xl text-sm font-medium transition-all duration-300 flex items-center gap-3 min-w-[300px] border border-white/20 backdrop-blur-md"
      >
        <span id="statusIcon"></span>
        <span id="statusText"></span>
      </div>

      <!-- Settings Modal -->
      <div
        id="settingsPanel"
        class="hidden absolute top-0 left-0 w-full z-30 glass-panel rounded-2xl p-4 shadow-2xl animate-fade-in"
      >
        <h3 class="font-bold text-slate-700 mb-2">API 設定</h3>
        <div class="space-y-3">
          <div>
            <label class="text-xs text-slate-500">Gemini API Key</label>
            <input
              type="password"
              id="apiKeyInput"
              placeholder="貼上 AIza 開頭的金鑰"
              class="w-full mt-1 px-3 py-2 border rounded text-xs"
            />
          </div>
        </div>
        <div class="flex justify-end mt-4">
          <button
            onclick="saveSettings()"
            class="bg-blue-600 text-white px-5 py-2 rounded-lg text-sm font-medium"
          >
            儲存
          </button>
        </div>
      </div>

      <!-- Start Screen -->
      <div
        id="startScreen"
        class="glass-panel rounded-3xl p-6 shadow-2xl flex flex-col items-center justify-center min-h-[400px] gap-6 animate-fade-in"
      >
        <div
          class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center text-blue-600 shadow-inner"
        >
          <i data-lucide="camera" class="w-10 h-10"></i>
        </div>
        <div class="text-center">
          <h2 class="text-xl font-bold text-slate-800">開始測試</h2>
          <p class="text-sm text-slate-500 mt-1">請確保相機權限已開啟</p>
        </div>
        <div class="w-full space-y-3">
          <button
            onclick="startCamera()"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 transition-transform active:scale-95"
          >
            <i data-lucide="aperture" class="w-5 h-5"></i>
            開啟相機 (推薦)
          </button>
          <button
            onclick="triggerFileInput()"
            class="w-full bg-white hover:bg-slate-50 text-slate-600 py-3.5 rounded-xl font-bold flex items-center justify-center gap-2 transition-transform active:scale-95 border border-slate-200"
          >
            <i data-lucide="image" class="w-5 h-5"></i>
            上傳圖片
          </button>
        </div>
        <input
          type="file"
          id="fileInput"
          accept="image/*"
          class="hidden"
          onchange="handleFileSelect(event)"
        />
      </div>

      <!-- ★ Camera Interface (全螢幕 + 浮層) ★ -->
      <div id="cameraInterface" class="hidden">
        <!-- Top Bar -->
        <div
          class="absolute top-0 left-0 right-0 z-[100] p-4 flex justify-between items-center text-white bg-gradient-to-b from-black/60 to-transparent"
        >
          <button
            onclick="closeCamera()"
            class="p-2 bg-white/10 rounded-full backdrop-blur-md"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
          <span class="text-sm font-medium tracking-wider shadow-sm"
            >將名片放入框內</span
          >
          <button
            onclick="switchCamera()"
            class="p-2 bg-white/10 rounded-full backdrop-blur-md"
          >
            <i data-lucide="refresh-ccw" class="w-6 h-6"></i>
          </button>
        </div>

        <!-- Video & Guide Layer -->
        <video id="cameraFeed" autoplay playsinline></video>
        <canvas id="cameraCanvas" class="hidden"></canvas>

        <div class="guide-overlay">
          <div class="guide-box">
            <div class="corner tl"></div>
            <div class="corner tr"></div>
            <div class="corner bl"></div>
            <div class="corner br"></div>
            <div class="scan-laser"></div>
          </div>
        </div>

        <!-- Bottom Trigger -->
        <div
          class="absolute bottom-0 left-0 right-0 h-32 bg-black/50 backdrop-blur-sm flex flex-col justify-center items-center pb-6 z-[100]"
        >
          <button
            onclick="takePhoto()"
            class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center active:scale-95 transition-transform bg-white/20"
          >
            <div class="w-16 h-16 bg-white rounded-full"></div>
          </button>
        </div>
      </div>

      <!-- Processing State -->
      <div
        id="processingState"
        class="hidden flex-col items-center justify-center fixed inset-0 z-[100] bg-black/90 backdrop-blur-md"
      >
        <div class="relative w-20 h-20 mb-4">
          <div
            class="absolute inset-0 border-4 border-slate-500/30 rounded-full"
          ></div>
          <div
            class="absolute inset-0 border-4 border-blue-500 rounded-full border-t-transparent animate-spin"
          ></div>
        </div>
        <p class="text-white font-bold text-lg">AI 正在分析...</p>
      </div>

      <!-- Result Card -->
      <div
        id="resultCard"
        class="glass-panel rounded-2xl p-0 shadow-xl hidden transition-all duration-500 overflow-hidden flex flex-col max-h-[85vh] w-full"
      >
        <div class="bg-slate-50 border-b p-3 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-full bg-slate-200 overflow-hidden border border-slate-300 relative"
            >
              <img
                id="contactPhotoPreview"
                class="w-full h-full object-cover"
              />
            </div>
            <div>
              <h3 class="text-sm font-bold text-slate-700">辨識結果</h3>
            </div>
          </div>
          <button
            onclick="resetApp()"
            class="text-xs text-red-500 hover:text-red-600 px-2 py-1"
          >
            重掃
          </button>
        </div>

        <form
          id="contactForm"
          class="p-4 space-y-3 bg-white flex-1 overflow-y-auto"
        >
          <div class="grid grid-cols-2 gap-3">
            <div class="space-y-1">
              <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
                >姓名</label
              >
              <input
                type="text"
                id="fieldName"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-800 font-bold"
              />
            </div>
            <div class="space-y-1">
              <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
                >職稱</label
              >
              <input
                type="text"
                id="fieldTitle"
                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-600 text-sm"
              />
            </div>
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >公司</label
            >
            <input
              type="text"
              id="fieldCompany"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >手機</label
            >
            <input
              type="tel"
              id="fieldMobile"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >Email</label
            >
            <input
              type="email"
              id="fieldEmail"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
          <div class="space-y-1">
            <label class="text-[10px] text-slate-400 font-bold uppercase ml-1"
              >地址</label
            >
            <input
              type="text"
              id="fieldAddress"
              class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm"
            />
          </div>
        </form>
      </div>
    </main>

    <script>
      // --- 設定與狀態 ---
      let AUTO_API_KEY = localStorage.getItem("gemini_api_key") || "";
      const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

      let stream = null;
      let facingMode = "environment"; // 預設後鏡頭

      document.addEventListener("DOMContentLoaded", () => {
        lucide.createIcons();
        document.getElementById("apiKeyInput").value = AUTO_API_KEY;
        if (!AUTO_API_KEY) toggleSettings();
      });

      // --- 相機功能 (WebRTC) ---
      async function startCamera() {
        try {
          // 嘗試請求高解析度
          stream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: facingMode,
              width: { ideal: 1920 },
              height: { ideal: 1080 },
            },
          });

          const video = document.getElementById("cameraFeed");
          video.srcObject = stream;

          // 顯示介面
          document.getElementById("startScreen").classList.add("hidden");
          document.getElementById("cameraInterface").classList.remove("hidden");
        } catch (err) {
          console.error(err);
          showToast("error", "無法開啟相機，請確認權限或使用 HTTPS");
        }
      }

      function stopCamera() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
      }

      function closeCamera() {
        stopCamera();
        document.getElementById("cameraInterface").classList.add("hidden");
        document.getElementById("startScreen").classList.remove("hidden");
      }

      async function switchCamera() {
        stopCamera();
        facingMode = facingMode === "environment" ? "user" : "environment";
        await startCamera();
      }

      // --- 拍照與自動處理 (不裁切) ---
      function takePhoto() {
        const video = document.getElementById("cameraFeed");
        const canvas = document.getElementById("cameraCanvas");

        // 抓取當前畫面
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);

        // 轉成 Base64
        const fullBase64 = canvas.toDataURL("image/jpeg", 0.85).split(",")[1];

        // 製作一個預覽用的小縮圖
        const tCanvas = document.createElement("canvas");
        tCanvas.width = 200;
        tCanvas.height = 200;
        // 簡單縮放
        tCanvas.getContext("2d").drawImage(canvas, 0, 0, 200, 200);
        document.getElementById("contactPhotoPreview").src = tCanvas.toDataURL(
          "image/jpeg",
          0.6
        );

        // 關閉相機，開始分析
        closeCamera();
        analyzeImage(fullBase64);
      }

      // --- 檔案上傳 Fallback ---
      function triggerFileInput() {
        document.getElementById("fileInput").click();
      }
      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            const c = document.createElement("canvas");
            c.width = img.width;
            c.height = img.height;
            c.getContext("2d").drawImage(img, 0, 0);
            const b64 = c.toDataURL("image/jpeg", 0.85).split(",")[1];
            document.getElementById("contactPhotoPreview").src =
              ev.target.result;
            analyzeImage(b64);
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      }

      // --- AI 分析核心 ---
      async function analyzeImage(base64Data) {
        const loading = document.getElementById("processingState");
        loading.classList.remove("hidden");
        loading.classList.add("flex");

        try {
          // Prompt: 告訴 AI 即使背景雜亂也要找出名片
          const prompt = `Analyze this image. Find the business card in the frame (even if rotated or on a table). Extract: name, title, company, mobile, email, address. Return strictly JSON. Missing fields=""`;

          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${AUTO_API_KEY}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      { text: prompt },
                      {
                        inlineData: {
                          mimeType: "image/jpeg",
                          data: base64Data,
                        },
                      },
                    ],
                  },
                ],
              }),
            }
          );

          const data = await response.json();
          let text = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
          text = text
            .replace(/```json/g, "")
            .replace(/```/g, "")
            .trim();
          if (text.indexOf("{") > -1)
            text = text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1);

          const card = JSON.parse(text);

          // 填入表單
          document.getElementById("fieldName").value = card.name || "";
          document.getElementById("fieldTitle").value = card.title || "";
          document.getElementById("fieldCompany").value = card.company || "";
          document.getElementById("fieldMobile").value = card.mobile || "";
          document.getElementById("fieldEmail").value = card.email || "";
          document.getElementById("fieldAddress").value = card.address || "";

          loading.classList.add("hidden");
          loading.classList.remove("flex");
          document.getElementById("resultCard").classList.remove("hidden");
          document.getElementById("startScreen").classList.add("hidden"); // 確保首頁隱藏
        } catch (error) {
          console.error(error);
          loading.classList.add("hidden");
          loading.classList.remove("flex");
          document.getElementById("startScreen").classList.remove("hidden");
          showToast("error", "辨識失敗，請檢查 Key 或網路");
        }
      }

      // --- UI 工具 ---
      function toggleSettings() {
        document.getElementById("settingsPanel").classList.toggle("hidden");
      }
      function saveSettings() {
        AUTO_API_KEY = document.getElementById("apiKeyInput").value.trim();
        localStorage.setItem("gemini_api_key", AUTO_API_KEY);
        toggleSettings();
        showToast("success", "設定已儲存");
      }
      function resetApp() {
        document.getElementById("resultCard").classList.add("hidden");
        document.getElementById("startScreen").classList.remove("hidden");
      }
      function showToast(type, msg) {
        const t = document.getElementById("statusToast");
        const i = document.getElementById("statusIcon");
        const txt = document.getElementById("statusText");
        // Reset classes
        t.className =
          "fixed top-20 left-1/2 transform -translate-x-1/2 z-[100] px-4 py-3 rounded-xl shadow-2xl text-sm font-medium transition-all duration-300 flex items-center gap-3 min-w-[300px] border border-white/20 backdrop-blur-md";
        if (type === "error") {
          t.classList.add("bg-red-500/90", "text-white", "border-red-400");
          i.innerHTML = `<i data-lucide="alert-circle" class="w-5 h-5"></i>`;
        } else {
          t.classList.add("bg-green-500/90", "text-white", "border-green-400");
          i.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5"></i>`;
        }
        txt.innerText = msg;
        t.classList.remove("hidden");
        lucide.createIcons();
        setTimeout(() => t.classList.add("hidden"), 3000);
      }
    </script>
  </body>
</html>
